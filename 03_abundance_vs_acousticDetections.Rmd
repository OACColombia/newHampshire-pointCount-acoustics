---
editor_options: 
  chunk_output_type: console
---

# Abundance vs. acoustic detections

In this script, we will associations between abundance as estimated from point count data and acoustic detections, which were manually annotated from simultaneously paired audio recorders. 

## Load necessary libraries  
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(scico)
library(data.table)
library(extrafont)
library(sf)
library(raster)
library(scales)
library(ggplot2)
library(ggspatial)
library(colorspace)
library(lubridate)
library(naniar)
library(ggstatsplot)
library(patchwork)
library(ggpmisc)
```

## Load dataframe containing point count and acoustic data
```{r}
datSubset <- read.csv("results/datSubset.csv")
```

## Creating a single dataframe prior to running statistical analysis

```{r}
## filter out species that were only detected in one approach and not in the other

## Nine species were detected only in point count data but not in the acoustic data and can be ignored for downstream analysis: Herring Gull, Northern Cardinal, American Goshawk, Swamp Sparrow, Red-bellied Woodpecker, Pine Siskin, Savannah Sparrow, Eastern Kingbird, Brown-headed Cowbird
## we will remove the above list of species from the point count data
point_count <- datSubset %>%
  filter(data_type == "point_count") %>%
  filter(!common_name %in% c("Herring Gull", 
                             "Northern Cardinal", "American Goshawk", 
                             "Swamp Sparrow", "Red-bellied Woodpecker", 
                             "Pine Siskin",
                             "Savannah Sparrow", "Eastern Kingbird", 
                             "Brown-headed Cowbird"
                             ))

## Six species were detected only in acoustic data and not in the point count data and can also be ignored for downstream analysis: Cape May Warbler, Gray Catbird, Mallard, Prairie Warbler, House Wren, Bobolink
acoustic_data <- datSubset %>%
  filter(data_type == "acoustic_data") %>%
  filter(!common_name %in% c("Cape May Warbler", "Gray Catbird", 
                             "Mallard", "Prairie Warbler", 
                             "House Wren", "Bobolink"
                             ))

# estimate abundance for each species for each site/visit combination
# ignore distance for now as we can model it in future analysis
abundance <- point_count %>%
  group_by(site_id, site_name, year, visit_number,
           scientific_name,
           common_name) %>% 
  summarise(abundance = sum(abundance)) %>%
  ungroup()

# estimate detections for each species for each site and year combination using the manual annotations of the acoustic data
detections <- acoustic_data %>%
  group_by(site_id, site_name, year, visit_number,
           scientific_name,
           common_name) %>% 
  summarise(detections = n()) %>%
  ungroup()

## sanity check to ensure that we are not including any species in either data type by mistake
pc_not_aru <- unique(anti_join(abundance[,6], 
                               detections[,6]))
aru_not_pc <- unique(anti_join(detections[,6], 
                               abundance[,6]))
## looks like we are good to join both datasets

# create a single dataframe
data <- full_join(abundance, detections) %>%
  replace_na(list(abundance = 0, detections = 0))
```

## Species-specific correlations

Here, we run analysis correlating abundance and detections for each species across years. 

```{r}
## using a random cutoff of a minimum of ten individuals in point count
## grouping by species, year (2022 or 2023) since vocal activity may vary by season and site_name (regional variation as a function of site/habitat)
spp_subset <-  data %>%
  group_by(common_name, year, site_name) %>%
  summarise(abundance = sum(abundance), detections = sum(detections)) %>%
  ungroup() %>%
  filter(abundance >=10 & detections >= 10)

## keeping only the subset of species
data <- data %>%
  semi_join(spp_subset, by = c("common_name", "year", "site_name"))

# define color palette
colors <- c("#2d1b69", "#548150FF", "#DEB738FF","#852419FF")

# change structure of year (commenting it out for now)
# data$year <- as.factor(data$year)

# plots to be created species by species
plots <- list()

for(i in 1:length(unique(data$common_name))){
  
# extract species common name
a <- unique(data$common_name)[i]
  
# subset data for plotting
for_plot <- data[data$common_name==a,]

# visualization
plots[[i]] <- ggplot(for_plot, 
            aes(x = detections, y = abundance, color = site_name, 
                fill = site_name)) +
  geom_point(aes(shape = site_name), size = 3, alpha = 0.8) +
  
  # adding regression lines
  geom_smooth(method = "lm", se = TRUE, alpha = 0.15, linewidth = 1.2) +
  
  # adding RÂ² values for each line 
  stat_poly_eq(aes(label = after_stat(rr.label)), 
               formula = y ~ x,
               parse = TRUE,
               size = 3,
               label.x = 0.95,
               label.y = c(0.95, 0.85, 0.75, 0.65)) + 
  scale_color_manual(values = colors, name = "Site Name") +
  scale_fill_manual(values = colors, name = "Site Name") +
  scale_shape_manual(values = c(16, 17, 15, 18), name = "Site Name") +
  #facet_wrap(~year, scales = "free") +
  labs(
    x = "Acoustic detections",
    y = "Abundance (point-count)",
    title = a
  ) +
    theme_bw() +
  theme(
    text = element_text(family = "Century Gothic", size = 15, face = "bold"),
    plot.title = element_text(family = "Century Gothic", size = 18, face = "bold"),
    axis.title = element_text(family = "Century Gothic", size = 15, face = "bold"),
    legend.title = element_text(family = "Century Gothic", size = 12, face = "bold"),
    legend.text = element_text(family = "Century Gothic", size = 10),
    strip.text = element_text(family = "Century Gothic", size = 12, face = "bold"),
    panel.grid.minor = element_blank()
  )
}

# plot and save as a single pdf
cairo_pdf(
  filename = "figs/abundance-acousticDetections-by-species.pdf",
  width = 12, height = 8,
  onefile = TRUE
)
plots
dev.off() 
```

