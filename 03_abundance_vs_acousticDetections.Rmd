---
editor_options: 
  chunk_output_type: console
---

# Abundance vs. acoustic detections

In this script, we will explore correlations and regressions between abundance and acoustic detections across species and sites.

## Load necessary libraries  
```{r}
library(tidyverse)
library(dplyr)
library(stringr)
library(vegan)
library(scico)
library(data.table)
library(extrafont)
library(sf)
library(raster)
library(scales)
library(ggplot2)
library(ggspatial)
library(colorspace)
library(lubridate)
library(naniar)
library(ggstatsplot)
```

## Load dataframe containing point count and acoustic data
```{r}
datSubset <- read.csv("results/datSubset.csv")
```

## Creating a single dataframe prior to running statistical analysis

```{r}
## filter out species that were only detected in one approach and not in the other

## Nine species were detected only in point count data but not in the acoustic data and can be ignored for downstream analysis: Herring Gull, Northern Cardinal, American Goshawk, Swamp Sparrow, Red-bellied Woodpecker, Pine Siskin, Savannah Sparrow, Eastern Kingbird, Brown-headed Cowbird
## we will remove the above list of species from the point count data
point_count <- datSubset %>%
  filter(data_type == "point_count") %>%
  filter(!common_name %in% c("Herring Gull", 
                             "Northern Cardinal", "American Goshawk", 
                             "Swamp Sparrow", "Red-bellied Woodpecker", 
                             "Pine Siskin",
                             "Savannah Sparrow", "Eastern Kingbird", 
                             "Brown-headed Cowbird"
                             ))

## Six species were detected only in acoustic data and not in the point count data and can also be ignored for downstream analysis: Cape May Warbler, Gray Catbird, Mallard, Prairie Warbler, House Wren, Bobolink
acoustic_data <- datSubset %>%
  filter(data_type == "acoustic_data") %>%
  filter(!common_name %in% c("Cape May Warbler", "Gray Catbird", 
                             "Mallard", "Prairie Warbler", 
                             "House Wren", "Bobolink"
                             ))

# estimate abundance for each species for each site/visit combination
# ignore distance for now as we can model it in future analysis
abundance <- point_count %>%
  group_by(site_id, site_name, year, visit_number,
           scientific_name,
           common_name) %>% 
  summarise(abundance = sum(abundance)) %>%
  ungroup()

# estimate detections for each species for each site and year combination using the manual annotations of the acoustic data
detections <- acoustic_data %>%
  group_by(site_id, site_name, year, visit_number,
           scientific_name,
           common_name) %>% 
  summarise(detections = n()) %>%
  ungroup()

## sanity check to ensure that we are not including any species in either data type by mistake
pc_not_aru <- unique(anti_join(abundance[,6], 
                               detections[,6]))
aru_not_pc <- unique(anti_join(detections[,6], 
                               abundance[,6]))
## looks like we are good to join both datasets

# create a single dataframe
data <- full_join(abundance, detections) %>%
  replace_na(list(abundance = 0, detections = 0))
```

## Correlative analysis

run this first, faceting by year and regional level
repeat then at a species-specific level, year & regional level
```{r}
## prior to running correlations, we get rid of species with very few counts of either abundance or detections within each year
## essentially, we want to filter out rarities at this stage 

## using a random cutoff of a minimum of 10 individuals in point count
## grouping by species, year (2022 or 2023) since vocal activity may vary by season and site_name (regional variation as a function of site/habitat)
spp_subset <-  data %>%
  group_by(common_name, year, site_name) %>%
  summarise(abundance = sum(abundance), detections = sum(detections)) %>%
  ungroup() %>%
  filter(abundance >=10 & detections >= 10)

# subset the data
# Only 38 species remain if we were to keep the above filters
data <- data %>%
  filter(common_name %in% spp_subset$common_name)

# visualization
# for the first correlation, let's pool data at a regional level
grouped_data <- data %>%
  group_by(site_name, year, scientific_name, common_name) %>%
  summarise(abundance = sum(abundance),
            detections = sum(detections)) %>%
  ungroup()

# create a grouping variable for visualization
grouped_data$year_site <- paste(grouped_data$year, 
                                grouped_data$site_name, 
                                sep = " - ")

# visualize
fig_abund_detec_community <- grouped_ggscatterstats(
  data = grouped_data,
  y = abundance,
  x = detections,
  type = "r",
  ylab = "Abundance (point-count)",
  xlab = "Acoustic detections",
  grouping.var = year_site,
  label.var = common_name, 
  label.expression = detections > 500,
  ggplot.component = list(theme(text = element_text(family = "Century Gothic", size = 15, face = "bold"),plot.title = element_text(family = "Century Gothic",
      size = 18, face = "bold"),
      plot.subtitle = element_text(family = "Century Gothic", 
      size = 15, face = "bold",color="#1b2838"),
      axis.title = element_text(family = "Century Gothic",
      size = 15, face = "bold"))))

ggsave(fig_abund_detec_community, filename = "figs/abundance_vs_detections_pooled_across_sites_by_year.png", width = 25, height = 12, device = png(), units = "in", dpi = 300)
dev.off() 

# inferences: patterns of correlations are reflective of the bird community across regional sites and years. We see closely/fairly close values of correlation between point count data and acoustic detections within a region across years. For example, HBEF between 2022 and 2023 is showing correlations of 0.76 and 0.82. However, this includes data that is pooled across species and one must test if such patterns emerge within species. 
```



